(window.webpackJsonp=window.webpackJsonp||[]).push([[136],{450:function(t,s,v){t.exports=v.p+"assets/img/image-20220311092656179.3e2e4718.png"},875:function(t,s,v){"use strict";v.r(s);var _=v(15),a=Object(_.a)({},(function(){var t=this,s=t.$createElement,_=t._self._c||s;return _("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[_("h1",{attrs:{id:"哨兵机制是怎样的"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#哨兵机制是怎样的"}},[t._v("#")]),t._v(" 哨兵机制是怎样的？")]),t._v(" "),_("p",[t._v("哨兵主要负责的就是三个任务:监控、选主和通知。")]),t._v(" "),_("p",[t._v("监控是指哨兵进程在运行时，周期性地给所有的主从库发送 PING 命令， 检测它们是否仍然在线运行。")]),t._v(" "),_("p",[_("img",{attrs:{src:v(450),alt:"img"}})]),t._v(" "),_("p",[t._v("为了减少单个哨兵节点误判情况，通常会采用多实例组成的集群模式进行部署，这也被称为哨兵集群。一半以上的哨兵节点为有效判断。")]),t._v(" "),_("h1",{attrs:{id:"如何选定新主库"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#如何选定新主库"}},[t._v("#")]),t._v(" 如何选定新主库?")]),t._v(" "),_("p",[t._v("哨兵选择新主库的过程称为“筛选 + 打分”。")]),t._v(" "),_("p",[t._v("筛选就是，在选主时，除了要检查从库的当前在线状态，还要判断它之前的网络连接状态。如果从库总是和主库断连，而且断连次数超出了一定的阈值，我们就可以把这个从库筛掉了。")]),t._v(" "),_("p",[t._v("打分就是分别按照三个规则依次进行三轮打分，这三个 规则分别是从库优先级、从库复制进度以及从库 ID 号。只要在某一轮中，有从库得分最 高，那么它就是主库了，选主过程到此结束。如果没有出现得分最高的从库，那么就继续 进行下一轮。")]),t._v(" "),_("p",[_("strong",[t._v("第一轮:优先级最高的从库得分高。")])]),t._v(" "),_("p",[t._v("用户可以通过 slave-priority 配置项，给不同的从库设置不同优先级。")]),t._v(" "),_("p",[_("strong",[t._v("第二轮:和旧主库同步程度最接近的从库得分高。")])]),t._v(" "),_("p",[t._v("选择和旧主库同步最接近的那个从库作为新主库。")]),t._v(" "),_("p",[_("strong",[t._v("第三轮:ID 号小的从库得分高。")])]),t._v(" "),_("p",[t._v("在优先级和复制进度都相同的情况下，ID 号最小的从库得分最 高，会被选为新主库。")]),t._v(" "),_("p",[t._v("另外，主从切换是由 Leader 哨兵执行的，因此还要进行 Leader 选举。")]),t._v(" "),_("h1",{attrs:{id:"基于-pub-sub-机制的哨兵集群组成"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#基于-pub-sub-机制的哨兵集群组成"}},[t._v("#")]),t._v(" 基于 pub/sub 机制的哨兵集群组成")]),t._v(" "),_("p",[t._v("这些哨兵实例既然都不知道彼此的地址，又是怎么组成集群的呢？哨兵实例之间可以相互发现，要归功于 Redis 提供的 pub/sub 机制，也就是发布 / 订阅机制。")]),t._v(" "),_("p",[t._v("通过 pub/sub 机制，哨兵之间可以组成集群，同时，哨兵又通过 INFO 命令，获得了从库连接信息，也能和从库建立连接，并进行监控。同时也支持客户端从哨兵这里订阅消息。")])])}),[],!1,null,null,null);s.default=a.exports}}]);