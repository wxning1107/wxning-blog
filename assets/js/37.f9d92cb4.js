(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{1236:function(s,e,a){"use strict";a.r(e);var t=a(15),n=Object(t.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"只查一行的语句为什么变慢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#只查一行的语句为什么变慢"}},[s._v("#")]),s._v(" 只查一行的语句为什么变慢？")]),s._v(" "),t("p",[s._v("为了便于描述，我还是构造一个表，基于这个表来说明今天的问题。这个表有两个字段 id 和 c，并且我在里面插入了 10 万行记录。")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `c` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB;\n \ndelimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=1;\n  while(i<=100000)do\n    insert into t values(i,i);\n    set i=i+1;\n  end while;\nend;;\ndelimiter ;\n \ncall idata();\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("h1",{attrs:{id:"第一类-查询长时间不返回"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第一类-查询长时间不返回"}},[s._v("#")]),s._v(" 第一类：查询长时间不返回")]),s._v(" "),t("p",[s._v("在表 t 执行下面的 SQL 语句：")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> select * from t where id=1;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("查询结果长时间不返回。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(507),alt:"img"}})]),s._v(" "),t("p",[s._v("一般碰到这种情况的话，大概率是表 t 被锁住了。接下来分析原因的时候，"),t("strong",[s._v("一般都是首先执行一下 show processlist 命令")]),s._v("，看看当前语句处于什么状态。")]),s._v(" "),t("h1",{attrs:{id:"等-mdl-锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#等-mdl-锁"}},[s._v("#")]),s._v(" 等 MDL 锁")]),s._v(" "),t("p",[s._v("使用 show processlist 命令查看 Waiting for table metadata lock 的示意图:")]),s._v(" "),t("p",[t("img",{attrs:{src:a(508),alt:"img"}})]),s._v(" "),t("p",[s._v("出现这个状态表示的是，现在有一个线程正在表 t 上请求或者持有 MDL 写锁，把 select 语句堵住了。")]),s._v(" "),t("p",[s._v("这类问题的处理方式，就是找到谁持有 MDL 写锁，然后把它 kill 掉。")]),s._v(" "),t("h1",{attrs:{id:"等-flush"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#等-flush"}},[s._v("#")]),s._v(" 等 flush")]),s._v(" "),t("p",[s._v("在表 t 上，执行下面的 SQL 语句：")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> select * from information_schema.processlist where id=1;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("查出来这个线程的状态是 Waiting for table flush")]),s._v(" "),t("p",[t("img",{attrs:{src:a(509),alt:"img"}})]),s._v(" "),t("p",[s._v("出现 Waiting for table flush 状态的可能情况是：有一个 flush tables 命令被别的语句堵住了，然后它又堵住了我们的 select 语句。")]),s._v(" "),t("p",[s._v("还是需要 show processlist 找到阻塞的语句再 kill 掉它。")]),s._v(" "),t("h1",{attrs:{id:"等行锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#等行锁"}},[s._v("#")]),s._v(" 等行锁")]),s._v(" "),t("p",[s._v("现在，经过了表级锁的考验，我们的 select 语句终于来到引擎里了。")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> select * from t where id=1 lock in share mode; \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("由于访问 id=1 这个记录时要加读锁，如果这时候已经有一个事务在这行记录上持有一个写锁，我们的 select 语句就会被堵住。")]),s._v(" "),t("p",[s._v("找到它并kill掉。")]),s._v(" "),t("h1",{attrs:{id:"第二类-查询慢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第二类-查询慢"}},[s._v("#")]),s._v(" 第二类：查询慢")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> select * from t where id=1；\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("虽然扫描行数是 1，但执行时间却长达 800 毫秒。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(510),alt:"img"}})]),s._v(" "),t("p",[s._v("如果我把这个 slow log 的截图再往下拉一点，你可以看到下一个语句，select * from t where id=1 lock in share mode，执行时扫描行数也是 1 行，执行时间是 0.2 毫秒。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(511),alt:"img"}})]),s._v(" "),t("p",[s._v("看上去是不是更奇怪了？按理说 lock in share mode 还要加锁，时间应该更长才对啊。")]),s._v(" "),t("p",[s._v("实际上是因为有事务执行了大量的更新语句，导致我们的查询语句需要执行undo log回滚日志获取结果。")]),s._v(" "),t("p",[s._v("带 lock in share mode 的 SQL 语句，是当前读，因此会直接读到结果，所以速度很快；而 select * from t where id=1 这个语句，是一致性读，因此需要从更新后的值开始，依次执行 undo log，执行了 n 次以后，才将结果返回。")])])}),[],!1,null,null,null);e.default=n.exports},507:function(s,e,a){s.exports=a.p+"assets/img/image-20220306211301794.6e83119c.png"},508:function(s,e,a){s.exports=a.p+"assets/img/image-20220306211427433.8753c6b9.png"},509:function(s,e,a){s.exports=a.p+"assets/img/image-20220306211959952.2af517d4.png"},510:function(s,e,a){s.exports=a.p+"assets/img/image-20220306212651299.9002defd.png"},511:function(s,e,a){s.exports=a.p+"assets/img/image-20220306212755296.a3d69881.png"}}]);