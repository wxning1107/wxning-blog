(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{1283:function(s,e,t){"use strict";t.r(e);var n=t(15),i=Object(n.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"为啥禁止三表join关联"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为啥禁止三表join关联"}},[s._v("#")]),s._v(" 为啥禁止三表Join关联？")]),s._v(" "),n("p",[s._v("参考："),n("a",{attrs:{href:"https://www.bilibili.com/video/BV1GA411A7gJ/?spm_id_from=333.788",target:"_blank",rel:"noopener noreferrer"}},[s._v("阿里开发规范解读，为啥禁止三表Join关联？"),n("OutboundLink")],1)]),s._v(" "),n("p",[s._v("阿里开发规范：超过3个表禁止join。需要join的字段数据类型必须绝对一致，多表关联查询时保证被关联的字段有索引。即使双表join也要注意表索引，sql性能。")]),s._v(" "),n("p",[n("strong",[s._v("为什么禁用多表关联？")])]),s._v(" "),n("p",[s._v("首先是产品强制要求，阿里OceanBase只允许两表关联，MaCat只支持两表关联。")]),s._v(" "),n("p",[s._v("其二是mysql自身设计缺陷，超过3表关联时mysql sql优化器做的不好，而且NLJ多级嵌套器性能差，NLJ一般是小表关联大表，在判断小表的过程中需要对数据分布做计算，选择的算法一般是贪心算法和动态规划算法，关联的表一旦多起来会占用大量cpu资源做判断小表的计算工作，所以多表join性能比较差。")]),s._v(" "),n("p",[n("strong",[s._v("解决方案：")])]),s._v(" "),n("p",[s._v("1.多次select")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("select * from a where ...\nselect * from b where aid in(...)\nselect * from c where bid in(...)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("这是一个临时解决方案，适用数据量小的情况，而且是inner join。如果数据量大，第一个sql查出的aid如果是几万个，第二个sql查询会很慢。")]),s._v(" "),n("p",[s._v("2.反范式表")]),s._v(" "),n("p",[s._v("反范式表就是对上面3个表拼接成一张表单独存储，如果有join查询的场景直接面向反范式表查，在3表有新增或者修改时需要同步更新反范式表。")]),s._v(" "),n("p",[n("img",{attrs:{src:t(529),alt:"img"}})]),s._v(" "),n("p",[s._v("反范式表适合单库处理，数据量不大，并发也不大。")]),s._v(" "),n("p",[s._v("3.数据集市")]),s._v(" "),n("p",[s._v("数据集市就是每天从原始数据源中对数据进行抽取，通过ETL（ETL就是数据加工导出导入）对数据进行加工，生成报表，中间表，视图等。在金融行业会采用日中处理，通常在凌晨对数据进行数据加工，未来不对原始数据操作而是对数据集市进行操作。")]),s._v(" "),n("p",[n("img",{attrs:{src:t(530),alt:"img"}})]),s._v(" "),n("p",[s._v("ETL常见的一个做法就是倒排表：")]),s._v(" "),n("p",[s._v("对于下面订单明细表分表后查询订单id=2的数据需要扫描所有分片。")]),s._v(" "),n("p",[n("img",{attrs:{src:t(531),alt:"img"}})]),s._v(" "),n("p",[s._v("采用倒排表后查询就很快了。")]),s._v(" "),n("p",[n("img",{attrs:{src:t(532),alt:"img"}})])])}),[],!1,null,null,null);e.default=i.exports},529:function(s,e,t){s.exports=t.p+"assets/img/image-20220423113123982.e511eeef.png"},530:function(s,e,t){s.exports=t.p+"assets/img/image-20220423113511734.5b713d33.png"},531:function(s,e,t){s.exports=t.p+"assets/img/image-20220423114309057.34ae49b2.png"},532:function(s,e,t){s.exports=t.p+"assets/img/image-20220423113921598.0c4ccbe3.png"}}]);